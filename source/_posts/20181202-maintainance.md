---
title: 【完了】11/20のメンテナンスについて
date: 2018-12-02 13:38:30
---

日誌では事後報告になってしまいましたが、11/20にサーバ再起動を含むメンテナンスを実施しました。ユーザ及び接続先の管理者の皆さん、ご理解・ご協力ありがとうございました。

## 考えていたこと

* さくらインターネット側での収容ホストの再起動が12月頭に予定されていたため、先に再起動することにしました
    - サーバを再起動すると収容ホストが変わるとのことだったので
    - 自分が面倒見られるタイミングでやっておいたほうがもしもの際に対処しやすい
    - 日時もざっくりとした時間帯指定でなく、きちんと決めてユーザに予告ができる
* ついでに、8月にざっくり上げたままのサーバ構成を見直すことにしました
    - 前回はそろそろつらいかなくらいの気持ちで雑に 4コア/8GB から 8コア/16GB に上げていたら、偶然にも翌日がTwitterのUserStream廃止日で突発的なユーザ増加に耐えた
        + 画像はsidekiqの履歴で、前回の 8/16 は急に跳ね上がってるとこです。結局倍近くになったのであの時上げておいた事自体は正解だった。  
        ![](https://mstdn.maud.io/system/media_attachments/files/002/530/727/original/392c2171c9f54ee2.jpeg)
    - 現在はだいぶ落ち着いてきて、Mackerel見た感じでは8コアあってもそんなに使ってないのでは？という感じだった
        + `docker-compose build` もffmpegもフルに使うわけじゃないし…
    - 数週間コンテナ再起動無しが続くとメモリ食い潰されるのでこっちは下げるのやめとこう
        + 毎週のようにmasterに追随するので最近はあまり起こらないけども

## 実施内容

* [x] 事前の告知

<iframe src="https://mstdn.maud.io/@hota/101067760353185030/embed" class="mastodon-embed" style="max-width: 100%; border: 0" width="480"></iframe><script src="https://mstdn.maud.io/embed.js" async="async"></script>

* [x] `docker-compose down` でMastodonを安全に停止する
* [x] サーバをシャットダウンする
* [x] スペック変更（vCPU: 8コア → **6コア**）
* [x] サーバ起動
* [x] サービス再開

## 実施日時

* 2018-11-20 15:00 JST 頃より停止
* 4-5分程度でサービス再開

## おわりに

今回はシャットダウンを伴うこともあり、1週間前からの告知トゥート、announcements欄を使用した案内、など ~~普段いきなり「ご存知ですか！へいますたーの時間です！」とか言い出す弊インスタンスにしては~~ 入念な準備を経てのメンテナンスになりました。

今後も継続的な監視によりサーバ構成の見直しが発生するかもしれませんが、その時はまたご協力のほどよろしくお願いします。弊インスタンス最大のイベントであるノラととアニメ2期も企画進行中と予告されちゃったので詰まらせないようにしたいです。

{% twitter https://twitter.com/noratoto_anime/status/1068072365282615296 %}
